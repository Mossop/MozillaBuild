#! /bin/sh

link() {
  rm -f $BUILD_BASE/source/$1/.hg/$2
  ln $BUILD_BASE/source/unified/.hg/$2 $BUILD_BASE/source/$1/.hg/$2
}

buildrepo() {
  hg share $BUILD_BASE/source/unified $BUILD_BASE/source/$1
  link $1 bookmarks
  link $1 localtags
  hg -R $BUILD_BASE/source/$1 update $2
}

mkdir -p $BUILD_BASE/source/unified
curl curl ftp://ftp.mozilla.org/pub/firefox/bundles/mozilla-central.hg >$BUILD_BASE/source/mozilla-central.hg
hg init $BUILD_BASE/source/unified
hg -R $BUILD_BASE/source/unified unbundle $BUILD_BASE/source/mozilla-central.hg
rm $BUILD_BASE/source/mozilla-central.hg
hg -R $BUILD_BASE/source/unified pull baserepo
hg -R $BUILD_BASE/source/unified pull syncrepo

exec 3<&0
exec 0<"$BUILD_BASE/config/treetags"
while read TREE TAG
do
  buildrepo $TREE $TAG
done
exec 0<&3
exec 3<&-

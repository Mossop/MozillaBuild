#! /bin/sh

. $BUILD_BASE/bin/repoutils

mkdir -p $BUILD_BASE/source

bootstraprepo() {
  tree=$1
  if [ ! -d $BUILD_BASE/source/$tree ]; then
    info=`tree_info $tree` || exit 1
    repo=`repo_url $info`
    tag=`base_tag $info`
    working=`working_url $info`
    echo Bootstrapping ${tree}...

    mkdir -p $BUILD_BASE/source
    hg clone $repo $BUILD_BASE/source/$tree
    hg -R $BUILD_BASE/source/$tree update $tag

    cat <<EOF >$BUILD_BASE/source/$tree/.hg/hgrc
[paths]
working = $working
EOF

    if [ "$tree" != "trunk" ]; then
      hg -R $BUILD_BASE/source/$tree relink $BUILD_BASE/source/trunk
    fi
  fi
}

if [ "$1" ]; then
  bootstraprepo $1
else
  for tree in `trees`
  do
    bootstraprepo $tree
  done
fi

#! /bin/sh
#
# ***** BEGIN LICENSE BLOCK *****
# Version: MPL 1.1/GPL 2.0/LGPL 2.1
#
# The contents of this file are subject to the Mozilla Public License Version
# 1.1 (the "License"); you may not use this file except in compliance with
# the License. You may obtain a copy of the License at
# http://www.mozilla.org/MPL/
#
# Software distributed under the License is distributed on an "AS IS" basis,
# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
# for the specific language governing rights and limitations under the
# License.
#
# The Original Code is Mossop's Mozilla Build Environment.
#
# The Initial Developer of the Original Code is
#      Dave Townsend <dave.townsend@blueprintit.co.uk>.
#
# Portions created by the Initial Developer are Copyright (C) 2006
# the Initial Developer. All Rights Reserved.
#
# Contributor(s):
#
# Alternatively, the contents of this file may be used under the terms of
# either the GNU General Public License Version 2 or later (the "GPL"), or
# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
# in which case the provisions of the GPL or the LGPL are applicable instead
# of those above. If you wish to allow use of your version of this file only
# under the terms of either the GPL or the LGPL, and not to allow others to
# use your version of this file under the terms of the MPL, indicate your
# decision by deleting the provisions above and replace them with the notice
# and other provisions required by the GPL or the LGPL. If you do not delete
# the provisions above, a recipient may use your version of this file under
# the terms of any one of the MPL, the GPL or the LGPL.
#
# ***** END LICENSE BLOCK *****
#
# $HeadURL$
# $LastChangedBy$
# $Date$
# $Revision$
#

if [ "$1" ]; then
  config $1
fi

. $BUILD_BASE/bin/applyconfig

if [ ! -d $BUILD_BASE/clean ]; then
  mkdir $BUILD_BASE/clean
fi

if [ ! -d $BUILD_CLEAN ]; then
  mkdir $BUILD_CLEAN
fi

if [ -f $BUILD_CLEAN/cvsco.log ]; then
  rm $BUILD_CLEAN/cvsco.log
fi

cd $BUILD_CLEAN
CLFLAGS="-A"
if [ "$MOZ_CO_TAG" ]; then
  FLAGS="$FLAGS \"MOZ_CO_TAG=$MOZ_CO_TAG\""
  CLFLAGS="-r $MOZ_CO_TAG"
fi

FLAGS="MOZ_CO_PROJECT=$MOZ_CO_PROJECT"
if [ "$MOZ_CO_DATE" ]; then
  FLAGS="$FLAGS \"MOZ_CO_DATE=$MOZ_CO_DATE\""
  CFFLAGS="$CLFLAGS -d \"$MOZ_CO_DATE\""
  TIME=`date --date="$MOZ_CO_DATE" +%s`
else
  TIME=`date +%s`
fi

cvs checkout $CLFLAGS mozilla/client.mk

if [ "$BUILD_PLATFORM" == "mac" ]; then
  CURRENTTZ=$TZ
  export TZ="US/Pacific"
  date -r $TIME +MOZ_BUILD_DATE=%Y%m%d%H >$BUILD_CLEAN/codate
  date -r $TIME +BUILD_CO_DATE=%Y%m%d.%H%M >>$BUILD_CLEAN/codate
  export TZ=$CURRENTTZ
  
  if [ ! -f mozilla/build/macosx/universal/mozconfig ]; then
    cvs checkout $CLFLAGS mozilla/build/macosx/universal/mozconfig
  fi
else
  TIME_OFFSET=`date --date="1970-01-01 00:00 PST" +%s`
  TIME=$(($TIME-$TIME_OFFSET))
  date --date=@$TIME +MOZ_BUILD_DATE=%Y%m%d%H >$BUILD_CLEAN/codate
  date --date=@$TIME +BUILD_CO_DATE=%Y%m%d.%H%M >>$BUILD_CLEAN/codate
fi

. $BUILD_CLEAN/codate

if [ "$BUILD_WATCH" ] && [ -f $BUILD_BASE/bin/buildwatch/buildwatch ]; then
  make -f mozilla/client.mk 2>&1 checkout $FLAGS | $BUILD_BASE/bin/buildwatch/buildwatch
else
  make -f mozilla/client.mk 2>&1 checkout $FLAGS
fi

if [ ! -d $BUILD_CLEAN/.git ]; then
  git-init
  git-config core.excludes ~/config/rcsignore
fi

git-add .
git-commit -a -m "CVS pull from $BUILD_CO_DATE"

if [ ! -d $BUILD_BASE/source ]; then
  mkdir $BUILD_BASE/source
fi

if [ ! -d $BUILD_SOURCE ]; then
  cd $BUILD_BASE/source
  git-clone -l $BUILD_CLEAN
  cd $BUILD_SOURCE
  stg init
else
  cd $BUILD_SOURCE
  stg pull
  stg clean
fi

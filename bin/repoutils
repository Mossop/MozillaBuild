current_tree() {
  REPO=`hg root` || exit 1
  ROOT=`basename $REPO`
  echo $ROOT
}

base_tag() {
  if [ "$1" ]; then
    TARGET=$1
  else
    TARGET=`current_tree` || exit 1
  fi

  exec 3<&0
  exec 0<"$BUILD_BASE/config/treetags"
  while read TREE TAG BUNDLE REPO
  do
    if [ "$TREE" == "$TARGET" ]; then
      BASE_TAG=$TAG
    fi
  done
  exec 0<&3
  exec 3<&-

  if [ "$BASE_TAG" ]; then
    echo $BASE_TAG
  else
    echo "I don't know the base tag for this repository" >&2
    exit 1
  fi
}

repo_url() {
  if [ "$1" ]; then
    TARGET=$1
  else
    TARGET=`current_tree` || exit 1
  fi

  exec 3<&0
  exec 0<"$BUILD_BASE/config/treetags"
  while read TREE TAG BUNDLE REPO
  do
    if [ "$TREE" = "$TARGET" ]; then
      TREE_REPO=$REPO
    fi
  done
  exec 0<&3
  exec 3<&-

  if [ "$TREE_REPO" ]; then
    echo $TREE_REPO
  else
    echo "I don't know the url for this repository" >&2
    exit 1
  fi
}

current_bookmark() {
  REPO_ROOT=`hg root` || exit 1

  if [ "$1" ]; then
    echo $1
  elif [ -f "$REPO_ROOT/.hg/bookmarks.current" ]; then
   cat $REPO_ROOT/.hg/bookmarks.current
  else
    echo "No active bookmark in this repository" >&2
    exit 1
  fi
}

#! /bin/bash

set -e

log() {
  :
}

if [ -z "$BUILD_BASE" ]; then
  PARENT=$(cd $(dirname "${BASH_SOURCE[0]}") && pwd)
  . $PARENT/buildrc
fi

. $BUILD_BASE/bin/applyconfig

cd $BUILD_BASE/source

TARGET="${1:-$BUILD_SOURCE}"
echo "Cloning into $BUILD_BASE/source/${TARGET}..."

git clone -o working git@github.com:Mossop/gecko-working.git "$BUILD_BASE/source/$TARGET"

cd "$BUILD_BASE/source/$TARGET"

mv .git/hooks/fsmonitor-watchman.sample .git/hooks/query-watchman
git config core.fsmonitor .git/hooks/query-watchman
git config fetch.prune true

git config --add remote.working.fetch 'refs/heads/work/*:refs/heads/work/*'
git config remote.working.push 'refs/heads/work/*:refs/heads/work/*'
git config --add remote.working.push 'refs/heads/central:refs/heads/central'
git fetch working

git status

function config() {
	echo "Setting up build environment for $1."
	export BUILD_CONFIG=$1
}

export BUILD_BASE=$HOME

# Here we build the path. The current path should only contain the VC stuff
VCPATH=$PATH

if [ -f /etc/profile ]; then
	. /etc/profile
fi

export MOZ_TOOLS=$BUILD_BASE/moztools
# The full path should have VC first, then cygwin
export PATH=$VCPATH:$MOZ_TOOLS/bin:$BUILD_BASE/bin:/usr/local/bin:/usr/bin:/bin:/usr/X11R6/bin
unset VCPATH

# BASEPATH should contain Window's standard path. This must go at the very end of the path.
if [ "$BASEPATH" ]; then
	BASEPATH=`cygpath -p "$BASEPATH"`
	PATH=$PATH:$BASEPATH
fi

export PST_OFFSET=`date --date="1970-01-01 00:00 PST" +%s`

# Load any config script
if [ -f $BUILD_BASE/config/default.config ]; then
	. $BUILD_BASE/config/default.config
fi

if [ "$BUILD_CONFIG" ]; then
	config $BUILD_CONFIG
fi

# Make sure the build dir exists
if [ ! -d $BUILD_BASE/build ]; then
	mkdir $BUILD_BASE/build
fi

export CVSROOT=:pserver:anonymous@cvs-mirror.mozilla.org:/cvsroot
if [ ! -f .cvspass ]; then
	echo -e "\nPlease press enter at the password prompt...\n"
	cvs login 2>/dev/null
fi

export WIN32_REDIST_DIR=$BUILD_BASE/redist
if [ ! -d $WIN32_REDIST_DIR ]; then
	REDIST=`echo $VCVARS | sed -e s/\"//g`
	REDIST=`cygpath "$REDIST"`
	REDIST=`dirname "$REDIST"`
	REDIST=$REDIST/redist/x86/Microsoft.VC80.CRT
	if [ -d "$REDIST" ]; then
		echo -e "\nAdding VC redistributable files."
		mkdir $WIN32_REDIST_DIR
		cp "$REDIST"/* $WIN32_REDIST_DIR
	fi
fi

if [ ! -d $MOZ_TOOLS ]; then
	echo -e "\nDownloading Mozilla Tools..."
	wget -q http://ftp.mozilla.org/pub/mozilla.org/mozilla/libraries/win32/moztools-static.zip
	echo "Extracting Mozilla Tools..."
	unzip moztools-static.zip >/dev/null
	rm -f moztools-static.zip
fi

export GLIB_PREFIX=$MOZ_TOOLS
export LIBIDL_PREFIX=$MOZ_TOOLS
export MOZCONFIG=$BUILD_BASE/config/.mozconfig
export -f config

echo -e "\nUse \"update\" to update the source tree and \"build\" to build it."
